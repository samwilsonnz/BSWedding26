<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wedding Registry Admin Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --navy: #1e3a5f;
            --light-navy: #2c5282;
            --beige: #f5f5dc;
            --cream: #faf8f3;
            --white: #ffffff;
            --gold: #d4af37;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --shadow: rgba(0, 0, 0, 0.1);
            --shadow-lg: rgba(0, 0, 0, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, var(--cream) 0%, var(--white) 30%, var(--beige) 70%, var(--cream) 100%);
            min-height: 100vh;
            color: var(--navy);
            line-height: 1.6;
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 2rem;
        }

        .login-container {
            background: var(--white);
            padding: 3rem;
            border-radius: 25px;
            box-shadow: 0 15px 35px var(--shadow);
            border: 3px solid var(--beige);
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        .login-container h1 {
            color: var(--navy);
            margin-bottom: 1rem;
            font-size: 2rem;
        }

        .login-container p {
            color: var(--light-navy);
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--navy);
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--beige);
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--navy);
        }

        .login-btn {
            width: 100%;
            background: linear-gradient(135deg, var(--navy) 0%, var(--light-navy) 100%);
            color: white;
            border: none;
            padding: 1rem;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(30, 58, 95, 0.3);
        }

        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--navy) 0%, var(--light-navy) 100%);
            color: white;
            padding: 2rem 0;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .logout-btn {
            position: absolute;
            top: 1rem;
            right: 2rem;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: white;
            color: var(--navy);
        }

        .back-to-registry {
            position: absolute;
            top: 1rem;
            left: 2rem;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .back-to-registry:hover {
            background: white;
            color: var(--navy);
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            background: var(--white);
            border-radius: 15px;
            padding: 0.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 5px 15px var(--shadow);
            border: 3px solid var(--beige);
        }

        .tab-btn {
            flex: 1;
            background: transparent;
            border: none;
            padding: 1rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            font-weight: 600;
            color: var(--light-navy);
        }

        .tab-btn.active {
            background: var(--navy);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(30, 58, 95, 0.3);
        }

        .tab-btn i {
            margin-right: 0.5rem;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--white);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 25px var(--shadow);
            border: 3px solid var(--beige);
            margin-bottom: 2rem;
        }

        .card h2 {
            color: var(--navy);
            margin-bottom: 1.5rem;
            font-size: 1.8rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--beige), var(--cream));
            border: 2px solid var(--navy);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
        }

        .stat-number {
            font-size: 3rem;
            font-weight: bold;
            color: var(--navy);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--light-navy);
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* Registry Items Management */
        .registry-items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .registry-item-card {
            background: var(--white);
            border: 3px solid var(--beige);
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            transition: all 0.3s ease;
            cursor: grab;
        }

        .registry-item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px var(--shadow-lg);
            border-color: var(--gold);
        }

        .registry-item-card.sortable-ghost {
            opacity: 0.4;
        }

        .registry-item-card.sortable-drag {
            transform: rotate(5deg);
            box-shadow: 0 20px 40px var(--shadow-lg);
        }

        .item-images-container {
            position: relative;
            height: 200px;
            display: flex;
        }

        .item-image-preview {
            width: 50%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.3s ease;
            border-right: 2px solid var(--beige);
        }

        .item-image-preview:last-child {
            border-right: none;
        }

        .item-image-preview:hover {
            transform: scale(1.05);
            z-index: 2;
        }

        .single-image {
            width: 100% !important;
            border-right: none !important;
        }

        .image-placeholder {
            width: 50%;
            height: 100%;
            background: linear-gradient(135deg, var(--beige), var(--cream));
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border-right: 2px solid var(--navy);
        }

        .image-placeholder:last-child {
            border-right: none;
        }

        .image-placeholder:hover {
            background: var(--navy);
            color: white;
        }

        .image-placeholder i {
            font-size: 2rem;
            opacity: 0.5;
        }

        .item-content {
            padding: 1.5rem;
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .item-title-editable {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--navy);
            border: none;
            background: transparent;
            width: 100%;
            margin-right: 1rem;
            padding: 0.5rem;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .item-title-editable:hover, .item-title-editable:focus {
            background: var(--cream);
            outline: 2px solid var(--navy);
        }

        .item-actions {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        .action-btn {
            padding: 0.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-btn:hover {
            transform: translateY(-2px);
        }

        .save-btn {
            background: var(--success);
            color: white;
        }

        .delete-btn {
            background: var(--error);
            color: white;
        }

        .drag-handle {
            background: var(--navy);
            color: white;
            cursor: grab;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .item-description-editable {
            width: 100%;
            min-height: 80px;
            border: 2px solid var(--beige);
            border-radius: 10px;
            padding: 1rem;
            font-family: inherit;
            font-size: 0.95rem;
            color: var(--light-navy);
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            resize: vertical;
        }

        .item-description-editable:focus {
            outline: none;
            border-color: var(--navy);
            box-shadow: 0 0 0 3px rgba(30, 58, 95, 0.1);
        }

        .item-store-link-editable {
            width: 100%;
            border: 2px solid var(--beige);
            border-radius: 10px;
            padding: 0.75rem;
            font-family: inherit;
            font-size: 0.9rem;
            color: var(--light-navy);
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .item-store-link-editable:focus {
            outline: none;
            border-color: var(--navy);
            box-shadow: 0 0 0 3px rgba(30, 58, 95, 0.1);
        }

        .store-link-display {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--navy);
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding: 0.4rem 0.8rem;
            background: var(--beige);
            border-radius: 15px;
            transition: all 0.3s ease;
        }

        .store-link-display:hover {
            background: var(--navy);
            color: var(--white);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px var(--shadow);
        }

        .store-link-display i {
            font-size: 0.7rem;
        }

        .item-meta {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .meta-field {
            display: flex;
            flex-direction: column;
        }

        .meta-field label {
            font-size: 0.9rem;
            font-weight: bold;
            color: var(--navy);
            margin-bottom: 0.5rem;
        }

        .meta-field input, .meta-field select {
            padding: 0.75rem;
            border: 2px solid var(--beige);
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .meta-field input:focus, .meta-field select:focus {
            outline: none;
            border-color: var(--navy);
            box-shadow: 0 0 0 3px rgba(30, 58, 95, 0.1);
        }

        .progress-info {
            background: var(--cream);
            padding: 1rem;
            border-radius: 10px;
            border: 2px solid var(--beige);
        }

        .progress-bar-mini {
            background: var(--beige);
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            margin: 0.5rem 0;
            position: relative;
        }

        .progress-fill-mini {
            background: linear-gradient(90deg, var(--navy) 0%, var(--light-navy) 50%, var(--gold) 100%);
            height: 100%;
            transition: width 0.3s ease;
        }

        .progress-text-mini {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: var(--navy);
            font-weight: 600;
        }

        /* Add New Item */
        .add-item-card {
            background: linear-gradient(135deg, var(--beige), var(--cream));
            border: 3px dashed var(--navy);
            border-radius: 20px;
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 300px;
        }

        .add-item-card:hover {
            background: var(--navy);
            color: white;
            transform: translateY(-5px);
            box-shadow: 0 15px 30px var(--shadow-lg);
        }

        .add-item-card i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.7;
        }

        .add-item-card h3 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .add-item-card p {
            opacity: 0.8;
        }

        /* Form Styles */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-field {
            margin-bottom: 1.5rem;
        }

        .form-field label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--navy);
            font-weight: bold;
        }

        .form-field input, .form-field select, .form-field textarea {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--beige);
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-field input:focus, .form-field select:focus, .form-field textarea:focus {
            outline: none;
            border-color: var(--navy);
            box-shadow: 0 0 0 3px rgba(30, 58, 95, 0.1);
        }

        .form-field textarea {
            height: 100px;
            resize: vertical;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem 2rem;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--navy) 0%, var(--light-navy) 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--error) 0%, #dc2626 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Image Upload */
        .images-upload-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .image-upload-area {
            border: 3px dashed var(--beige);
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            background: var(--cream);
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .image-upload-area:hover {
            border-color: var(--navy);
            background: var(--beige);
        }

        .image-upload-area.drag-over {
            border-color: var(--gold);
            background: var(--white);
        }

        .image-upload-area input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .upload-preview {
            max-width: 100%;
            max-height: 150px;
            border-radius: 10px;
            margin: 0;
        }

        .upload-content {
            pointer-events: none;
        }

        .upload-content i {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: var(--light-navy);
        }

        .clear-image-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--error);
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }

        .clear-image-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        .image-upload-area {
            position: relative;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: var(--white);
            margin: 2% auto;
            padding: 0;
            border-radius: 25px;
            width: 95%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
        }

        .modal-header {
            background: linear-gradient(135deg, var(--navy) 0%, var(--light-navy) 100%);
            color: white;
            padding: 2rem;
            border-radius: 25px 25px 0 0;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.8rem;
        }

        .modal-body {
            padding: 2rem;
        }

        .close {
            position: absolute;
            right: 2rem;
            top: 2rem;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            color: white;
            transition: color 0.3s ease;
            z-index: 1001;
        }

        .close:hover {
            color: var(--gold);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Table Styles */
        .table-container {
            overflow-x: auto;
            border-radius: 15px;
            box-shadow: 0 5px 15px var(--shadow);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--white);
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--beige);
        }

        th {
            background: var(--navy);
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
        }

        tbody tr:hover {
            background: var(--cream);
        }

        .status-badge {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-confirmed {
            background: var(--success);
            color: white;
        }

        .status-pending {
            background: var(--warning);
            color: white;
        }

        .status-declined {
            background: var(--error);
            color: white;
        }

        .status-accessed {
            background: var(--navy);
            color: white;
        }

        .status-not-accessed {
            background: var(--beige);
            color: var(--navy);
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: var(--success);
            color: white;
            padding: 1rem 2rem;
            border-radius: 15px;
            box-shadow: 0 10px 25px var(--shadow);
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            background: var(--error);
        }

        .toast.warning {
            background: var(--warning);
        }

        /* Save Indicator */
        .save-indicator {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--success);
            color: white;
            padding: 1rem 2rem;
            border-radius: 25px;
            box-shadow: 0 10px 25px var(--shadow);
            z-index: 1001;
            transform: translateY(100px);
            transition: transform 0.3s ease;
        }

        .save-indicator.show {
            transform: translateY(0);
        }

        .save-indicator.saving {
            background: var(--warning);
        }

        .save-indicator.error {
            background: var(--error);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .tab-nav {
                flex-direction: column;
                gap: 0.5rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .registry-items-grid {
                grid-template-columns: 1fr;
            }

            .item-meta {
                grid-template-columns: 1fr;
            }

            .logout-btn, .back-to-registry {
                position: static;
                margin: 0.5rem;
                display: inline-block;
            }

            .header {
                text-align: left;
                padding: 1rem;
            }

            .modal-content {
                width: 95%;
                margin: 5% auto;
            }

            .images-upload-container {
                grid-template-columns: 1fr;
            }
        }

        /* Hidden class */
        .hidden {
            display: none !important;
        }

        /* Loading States */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--navy);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Unsaved Changes Indicator */
        .unsaved-indicator {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 12px;
            height: 12px;
            background: var(--warning);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-container">
            <h1>üõ°Ô∏è Admin Access</h1>
            <p>Enter your 12-character admin code to manage the wedding registry</p>
            <form id="adminLoginForm">
                <div class="form-group">
                    <label for="adminCode">Admin Code</label>
                    <input type="text" id="adminCode" required maxlength="12" placeholder="12-CHARACTER CODE" style="text-transform: uppercase; letter-spacing: 2px; font-family: monospace;">
                </div>
                <button type="submit" class="login-btn" id="adminLoginBtn">
                    <i class="fas fa-unlock"></i> Access Admin Panel
                </button>
            </form>
        </div>
    </div>

    <!-- Admin Dashboard (Hidden initially) -->
    <div id="adminDashboard" class="hidden">
        <div class="header">
            <a href="/" class="back-to-registry">
                <i class="fas fa-arrow-left"></i> Back to Registry
            </a>
            <button class="logout-btn" id="adminLogoutBtn">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
            <h1>üõ°Ô∏è Wedding Registry Admin</h1>
            <p>Manage guests, view contributions, and edit registry items</p>
        </div>

        <div class="container">
            <!-- Stats Section -->
            <div class="stats-grid" id="statsGrid">
                <!-- Stats will be loaded here -->
            </div>

            <!-- Tab Navigation -->
            <div class="tab-nav">
                <button class="tab-btn" data-tab="registry">
                    <i class="fas fa-gift"></i> Registry Items
                </button>
                <button class="tab-btn active" data-tab="guests">
                    <i class="fas fa-users"></i> Guest Management
                </button>
                <button class="tab-btn" data-tab="rsvps">
                    <i class="fas fa-envelope-open-text"></i> RSVPs
                </button>
                <button class="tab-btn" data-tab="contributions">
                    <i class="fas fa-chart-bar"></i> Contribution Reports
                </button>
                <button class="tab-btn" data-tab="content">
                    <i class="fas fa-edit"></i> Content Editor
                </button>
            </div>

            <!-- Registry Items Tab -->
            <div id="registry-tab" class="tab-content">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <div>
                            <h2><i class="fas fa-gift"></i> Registry Items Management</h2>
                            <p style="color: var(--light-navy); margin-top: 0.5rem;">‚ú® <strong>NEW:</strong> Two photos per item ‚Ä¢ Store links ‚Ä¢ Drag and drop to reorder ‚Ä¢ Click items to edit ‚Ä¢ Changes save automatically</p>
                        </div>
                        <div style="display: flex; gap: 1rem;">
                            <button class="btn btn-success" id="saveAllOrderBtn">
                                <i class="fas fa-save"></i> Save Order
                            </button>
                            <button class="btn btn-primary" id="refreshItemsBtn">
                                <i class="fas fa-refresh"></i> Refresh
                            </button>
                        </div>
                    </div>

                    <div class="registry-items-grid" id="registryItemsGrid">
                        <!-- Items will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Guest Management Tab -->
            <div id="guests-tab" class="tab-content active">
                <div class="card">
                    <h2><i class="fas fa-user-plus"></i> Add New Guest</h2>
                    <form id="addGuestForm">
                        <div class="form-grid">
                            <div class="form-field">
                                <label for="guestName">Guest Name *</label>
                                <input type="text" id="guestName" required placeholder="John & Mary Smith">
                            </div>
                            <div class="form-field">
                                <label for="guestEmail">Email Address</label>
                                <input type="email" id="guestEmail" placeholder="john.smith@example.com">
                            </div>
                            <div class="form-field">
                                <label for="guestPhone">Phone Number</label>
                                <input type="tel" id="guestPhone" placeholder="+64 21 123 4567">
                            </div>
                            <div class="form-field">
                                <label for="invitationType">Invitation Type</label>
                                <select id="invitationType">
                                    <option value="individual">Individual</option>
                                    <option value="couple">Couple</option>
                                    <option value="family">Family</option>
                                </select>
                            </div>
                            <div class="form-field">
                                <label for="guestCount">Guest Count</label>
                                <input type="number" id="guestCount" min="1" value="1">
                            </div>
                            <div class="form-field">
                                <label for="dietaryRestrictions">Dietary Restrictions</label>
                                <input type="text" id="dietaryRestrictions" placeholder="Vegetarian, No nuts, etc.">
                            </div>
                        </div>
                        <div class="form-field">
                            <label for="guestNotes">Notes</label>
                            <textarea id="guestNotes" placeholder="Relationship, special instructions, etc."></textarea>
                        </div>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-plus"></i> Add Guest
                        </button>
                    </form>
                </div>

                <div class="card">
                    <h2><i class="fas fa-users"></i> Guest List</h2>
                    
                    <div style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap; align-items: center;">
                        <input type="text" placeholder="Search guests..." id="guestSearch" style="flex: 1; min-width: 200px; padding: 1rem; border: 2px solid var(--beige); border-radius: 25px;">
                        <select id="rsvpFilter" style="padding: 1rem; border: 2px solid var(--beige); border-radius: 25px;">
                            <option value="">All RSVP Status</option>
                            <option value="confirmed">Confirmed</option>
                            <option value="pending">Pending</option>
                            <option value="declined">Declined</option>
                        </select>
                        <select id="accessFilter" style="padding: 1rem; border: 2px solid var(--beige); border-radius: 25px;">
                            <option value="">All Access Status</option>
                            <option value="accessed">Has Accessed</option>
                            <option value="not-accessed">Not Accessed</option>
                        </select>
                    </div>

                    <div style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap;">
                        <button class="btn btn-warning" id="exportGuestsBtn">
                            <i class="fas fa-download"></i> Export Guest List
                        </button>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Guest Name</th>
                                    <th>Email</th>
                                    <th>Guest Code</th>
                                    <th>RSVP Status</th>
                                    <th>Access Status</th>
                                    <th>Contributed</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="guestsTableBody">
                                <!-- Guests will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- RSVPs Tab -->
            <div id="rsvps-tab" class="tab-content">
                <div class="card">
                    <h2><i class="fas fa-chart-pie"></i> RSVP Statistics</h2>
                    <div id="rsvpStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-top: 1.5rem;">
                        <div style="background: linear-gradient(135deg, var(--success) 0%, #059669 100%); color: white; padding: 1.5rem; border-radius: 15px; text-align: center;">
                            <i class="fas fa-check-circle" style="font-size: 2.5rem; margin-bottom: 0.5rem;"></i>
                            <div style="font-size: 2rem; font-weight: bold;" id="attendingCount">0</div>
                            <div style="opacity: 0.9;">Attending</div>
                        </div>
                        <div style="background: linear-gradient(135deg, var(--error) 0%, #dc2626 100%); color: white; padding: 1.5rem; border-radius: 15px; text-align: center;">
                            <i class="fas fa-times-circle" style="font-size: 2.5rem; margin-bottom: 0.5rem;"></i>
                            <div style="font-size: 2rem; font-weight: bold;" id="notAttendingCount">0</div>
                            <div style="opacity: 0.9;">Not Attending</div>
                        </div>
                        <div style="background: linear-gradient(135deg, var(--warning) 0%, #ea580c 100%); color: white; padding: 1.5rem; border-radius: 15px; text-align: center;">
                            <i class="fas fa-question-circle" style="font-size: 2.5rem; margin-bottom: 0.5rem;"></i>
                            <div style="font-size: 2rem; font-weight: bold;" id="maybeCount">0</div>
                            <div style="opacity: 0.9;">Maybe</div>
                        </div>
                        <div style="background: linear-gradient(135deg, var(--navy) 0%, var(--light-navy) 100%); color: white; padding: 1.5rem; border-radius: 15px; text-align: center;">
                            <i class="fas fa-users" style="font-size: 2.5rem; margin-bottom: 0.5rem;"></i>
                            <div style="font-size: 2rem; font-weight: bold;" id="totalGuestsCount">0</div>
                            <div style="opacity: 0.9;">Total Guests</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2><i class="fas fa-list"></i> All RSVPs</h2>
                        <button class="btn btn-primary" id="refreshRSVPsBtn">
                            <i class="fas fa-refresh"></i> Refresh
                        </button>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Attending</th>
                                    <th>Guests</th>
                                    <th>Dietary</th>
                                    <th>Message</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="rsvpsTableBody">
                                <!-- RSVPs will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Contribution Reports Tab -->
            <div id="contributions-tab" class="tab-content">
                <div class="card">
                    <h2><i class="fas fa-chart-bar"></i> Contribution Overview</h2>
                    <div id="contributionOverview">
                        <!-- Overview will be loaded here -->
                    </div>
                </div>

                <div class="card">
                    <h2><i class="fas fa-list"></i> Detailed Contribution Report</h2>
                    
                    <div style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap;">
                        <button class="btn btn-primary" id="refreshReportBtn">
                            <i class="fas fa-refresh"></i> Refresh Report
                        </button>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Guest Name</th>
                                    <th>Email</th>
                                    <th>Total Contributed</th>
                                    <th>Items Contributed To</th>
                                    <th>Last Contribution</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="contributionsTableBody">
                                <!-- Contributions will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Content Editor Tab -->
            <div id="content-tab" class="tab-content">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <div>
                            <h2><i class="fas fa-edit"></i> Website Content Editor</h2>
                            <p style="color: var(--light-navy); margin-top: 0.5rem;">Edit all text content on your wedding website. Changes are saved automatically.</p>
                        </div>
                        <button class="btn btn-primary" id="reloadContentBtn">
                            <i class="fas fa-sync-alt"></i> Reload Content
                        </button>
                    </div>

                    <!-- Content sections organized by category -->
                    <div id="contentEditorContainer">
                        <div class="content-loading">
                            <i class="fas fa-spinner fa-spin"></i> Loading content...
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Add/Edit Item Modal -->
    <div id="itemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" id="closeItemModal">&times;</span>
                <h3 id="itemModalTitle">Add New Registry Item</h3>
            </div>
            <div class="modal-body">
                <form id="itemForm">
                    <div class="form-grid">
                        <div class="form-field">
                            <label for="itemName">Item Name *</label>
                            <input type="text" id="itemName" required placeholder="e.g., KitchenAid Stand Mixer">
                        </div>
                        <div class="form-field">
                            <label for="itemCategory">Category</label>
                            <select id="itemCategory">
                                <option value="kitchen">Kitchen</option>
                                <option value="home">Home</option>
                                <option value="experiences">Experiences</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label for="itemTargetAmount">Target Amount ($)</label>
                            <input type="number" id="itemTargetAmount" min="0" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-field">
                            <label for="itemPriority">Priority</label>
                            <select id="itemPriority">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-field">
                        <label for="itemDescription">Description *</label>
                        <textarea id="itemDescription" required placeholder="Describe this item and why you'd love to have it..."></textarea>
                    </div>

                    <div class="form-field">
                        <label for="itemStoreLink">Store Link (Optional)</label>
                        <input type="url" id="itemStoreLink" placeholder="https://www.amazon.com/product-page or https://store.com/item">
                        <p style="font-size: 0.85rem; color: var(--light-navy); margin-top: 0.5rem;">
                            Add a link where guests can view or purchase this item online
                        </p>
                    </div>

                    <div class="form-field">
                        <label>Item Images (2 photos for collage display)</label>
                        <div class="images-upload-container">
                            <div class="image-upload-area" id="imageUploadArea1">
                                <input type="file" id="imageUpload1" accept="image/*">
                                <div class="upload-content" id="uploadContent1">
                                    <i class="fas fa-camera"></i>
                                    <p><strong>Primary Photo</strong></p>
                                    <p>Click or drag to upload</p>
                                </div>
                                <img id="uploadPreview1" class="upload-preview" style="display: none;">
                                <button type="button" id="clearImage1" class="clear-image-btn" style="display: none;" onclick="adminApp.clearImage(1)">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="image-upload-area" id="imageUploadArea2">
                                <input type="file" id="imageUpload2" accept="image/*">
                                <div class="upload-content" id="uploadContent2">
                                    <i class="fas fa-camera"></i>
                                    <p><strong>Secondary Photo</strong></p>
                                    <p>Click or drag to upload</p>
                                </div>
                                <img id="uploadPreview2" class="upload-preview" style="display: none;">
                                <button type="button" id="clearImage2" class="clear-image-btn" style="display: none;" onclick="adminApp.clearImage(2)">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <p style="font-size: 0.9rem; color: var(--light-navy); margin-top: 0.5rem;">
                            üí° Tip: Upload two photos to create a beautiful side-by-side collage display! Click the X to remove an image.
                        </p>
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                        <button type="button" class="btn" style="background: var(--beige); color: var(--navy);" onclick="closeItemModal()">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-success" id="saveItemBtn">
                            <i class="fas fa-save"></i> Save Item
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Guest Edit Modal -->
    <div id="guestModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" id="closeGuestModal">&times;</span>
                <h3 id="guestModalTitle">Edit Guest</h3>
            </div>
            <div class="modal-body">
                <form id="guestEditForm">
                    <input type="hidden" id="editGuestId">
                    <div class="form-grid">
                        <div class="form-field">
                            <label for="editGuestName">Name *</label>
                            <input type="text" id="editGuestName" required placeholder="Guest full name">
                        </div>
                        <div class="form-field">
                            <label for="editGuestEmail">Email</label>
                            <input type="email" id="editGuestEmail" placeholder="guest@example.com">
                        </div>
                        <div class="form-field">
                            <label for="editGuestPhone">Phone</label>
                            <input type="tel" id="editGuestPhone" placeholder="+64 21 123 4567">
                        </div>
                        <div class="form-field">
                            <label for="editGuestCode">Guest Code</label>
                            <input type="text" id="editGuestCode" readonly style="background: var(--beige); cursor: not-allowed;" placeholder="AUTO-GENERATED">
                            <p style="font-size: 0.85rem; color: var(--light-navy); margin-top: 0.3rem;">
                                Guest codes cannot be changed after creation
                            </p>
                        </div>
                        <div class="form-field">
                            <label for="editInvitationType">Invitation Type</label>
                            <select id="editInvitationType">
                                <option value="individual">Individual</option>
                                <option value="couple">Couple</option>
                                <option value="family">Family</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label for="editGuestCount">Guest Count</label>
                            <input type="number" id="editGuestCount" min="1" value="1">
                        </div>
                        <div class="form-field">
                            <label for="editRsvpStatus">RSVP Status</label>
                            <select id="editRsvpStatus">
                                <option value="pending">Pending</option>
                                <option value="attending">Attending</option>
                                <option value="declined">Declined</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-field">
                        <label for="editDietaryRestrictions">Dietary Restrictions</label>
                        <textarea id="editDietaryRestrictions" rows="2" placeholder="Any food allergies or dietary requirements..."></textarea>
                    </div>

                    <div class="form-field">
                        <label for="editGuestNotes">Notes</label>
                        <textarea id="editGuestNotes" rows="3" placeholder="Additional notes about this guest..."></textarea>
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                        <button type="button" class="btn" style="background: var(--beige); color: var(--navy);" onclick="closeGuestModal()">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-success" id="saveGuestBtn">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Save Indicator -->
    <div id="saveIndicator" class="save-indicator">
        <i class="fas fa-check"></i> <span id="saveIndicatorText">Changes saved</span>
    </div>

    <script>
        class AdminDashboard {
            constructor() {
                this.adminToken = null;
                this.guests = [];
                this.items = [];
                this.contributionReport = null;
                this.editingItemId = null;
                this.unsavedItems = new Set();
                this.saveTimeout = null;
                this.sortable = null;
                this.currentImageSlot = null;
                
                this.init();
            }

            async init() {
                this.checkAdminSession();
                this.setupEventListeners();
            }

            // Security: HTML escape function to prevent XSS attacks
            escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            checkAdminSession() {
                const token = sessionStorage.getItem('adminToken');
                if (token === 'admin-authenticated') {
                    this.adminToken = token;
                    this.showDashboard();
                } else {
                    this.showLoginScreen();
                }
            }

            showLoginScreen() {
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('adminDashboard').classList.add('hidden');
            }

            async showDashboard() {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('adminDashboard').classList.remove('hidden');
                
                await this.loadDashboardData();
            }

            setupEventListeners() {
                // Admin login
                document.getElementById('adminLoginForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.adminLogin();
                });

                // Admin logout
                document.getElementById('adminLogoutBtn').addEventListener('click', () => {
                    this.adminLogout();
                });

                // Tab navigation
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.switchTab(e.target.dataset.tab);
                    });
                });

                // Registry Items Management
                document.getElementById('refreshItemsBtn').addEventListener('click', () => {
                    this.loadRegistryItems();
                });

                document.getElementById('saveAllOrderBtn').addEventListener('click', () => {
                    this.saveItemOrder();
                });

                // Add guest form
                document.getElementById('addGuestForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.addGuest();
                });

                // Guest Edit Modal
                document.getElementById('closeGuestModal').addEventListener('click', () => {
                    this.closeGuestModal();
                });

                document.getElementById('guestEditForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.saveGuestChanges();
                });

                // Search and filters
                document.getElementById('guestSearch').addEventListener('input', () => {
                    this.filterGuests();
                });

                document.getElementById('rsvpFilter').addEventListener('change', () => {
                    this.filterGuests();
                });

                document.getElementById('accessFilter').addEventListener('change', () => {
                    this.filterGuests();
                });

                // Export buttons
                document.getElementById('exportGuestsBtn').addEventListener('click', () => {
                    this.exportGuestList();
                });

                document.getElementById('refreshReportBtn').addEventListener('click', () => {
                    this.loadContributionReport();
                });

                // RSVPs Management
                document.getElementById('refreshRSVPsBtn').addEventListener('click', () => {
                    this.loadRSVPs();
                });

                // Content Editor
                document.getElementById('reloadContentBtn').addEventListener('click', () => {
                    this.loadSiteContent();
                });

                // Item Modal
                document.getElementById('closeItemModal').addEventListener('click', () => {
                    this.closeItemModal();
                });

                document.getElementById('itemForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.saveItem();
                });

                // Image Upload for both slots
                this.setupImageUpload(1);
                this.setupImageUpload(2);

                // Close modals on outside click
                document.getElementById('itemModal').addEventListener('click', (e) => {
                    if (e.target.id === 'itemModal') {
                        this.closeItemModal();
                    }
                });

                document.getElementById('guestModal').addEventListener('click', (e) => {
                    if (e.target.id === 'guestModal') {
                        this.closeGuestModal();
                    }
                });
            }

            setupImageUpload(slot) {
                const imageUpload = document.getElementById(`imageUpload${slot}`);
                const uploadArea = document.getElementById(`imageUploadArea${slot}`);
                
                if (imageUpload && uploadArea) {
                    imageUpload.addEventListener('change', (e) => {
                        this.handleImageUpload(e.target.files[0], slot);
                    });

                    uploadArea.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        uploadArea.classList.add('drag-over');
                    });

                    uploadArea.addEventListener('dragleave', () => {
                        uploadArea.classList.remove('drag-over');
                    });

                    uploadArea.addEventListener('drop', (e) => {
                        e.preventDefault();
                        uploadArea.classList.remove('drag-over');
                        const file = e.dataTransfer.files[0];
                        if (file && file.type.startsWith('image/')) {
                            this.handleImageUpload(file, slot);
                        }
                    });
                }
            }

            async adminLogin() {
                try {
                    const adminCode = document.getElementById('adminCode').value;
                    const btn = document.getElementById('adminLoginBtn');
                    
                    if (!adminCode || adminCode.length !== 12) {
                        throw new Error('Please enter a valid 12-character admin code');
                    }

                    btn.innerHTML = '<i class="loading"></i> Accessing...';
                    btn.disabled = true;

                    const response = await fetch('/api/admin/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ adminCode: adminCode.toUpperCase() })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        this.adminToken = result.token;
                        sessionStorage.setItem('adminToken', this.adminToken);
                        await this.showDashboard();
                    } else {
                        const error = await response.json();
                        throw new Error(error.error || 'Invalid admin code');
                    }
                } catch (error) {
                    this.showToast(error.message || 'Access denied', 'error');
                    
                    const btn = document.getElementById('adminLoginBtn');
                    btn.innerHTML = '<i class="fas fa-unlock"></i> Access Admin Panel';
                    btn.disabled = false;
                }
            }

            adminLogout() {
                sessionStorage.removeItem('adminToken');
                this.adminToken = null;
                this.showLoginScreen();
                
                // Clear form
                document.getElementById('adminCode').value = '';
            }

            switchTab(tabName) {
                // Update tab buttons
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
                
                // Update tab content
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById(`${tabName}-tab`).classList.add('active');
                
                // Load tab-specific data
                switch(tabName) {
                    case 'registry':
                        this.loadRegistryItems();
                        break;
                    case 'rsvps':
                        this.loadRSVPs();
                        break;
                    case 'contributions':
                        this.loadContributionReport();
                        break;
                    case 'content':
                        this.loadSiteContent();
                        break;
                    case 'guests':
                        // Already loaded
                        break;
                }
            }

            async loadDashboardData() {
                try {
                    await Promise.all([
                        this.loadGuests(),
                        this.loadStats(),
                        this.loadRegistryItems()
                    ]);
                } catch (error) {
                    console.error('Error loading dashboard data:', error);
                    this.showToast('Error loading dashboard data', 'error');
                }
            }

            async loadRegistryItems() {
                try {
                    const response = await fetch('/api/items');
                    if (response.ok) {
                        this.items = await response.json();
                        this.renderRegistryItems();
                        this.setupSortable();
                    } else {
                        // Even if API fails, render the Add button
                        this.items = [];
                        this.renderRegistryItems();
                    }
                } catch (error) {
                    console.error('Error loading items:', error);
                    this.showToast('Error loading registry items - showing Add button anyway', 'warning');
                    // Even if API fails, render the Add button
                    this.items = [];
                    this.renderRegistryItems();
                }
            }

            renderRegistryItems() {
                const grid = document.getElementById('registryItemsGrid');
                
                // Add "Add New Item" card first
                const addItemCard = document.createElement('div');
                addItemCard.className = 'add-item-card';
                addItemCard.innerHTML = `
                    <i class="fas fa-plus"></i>
                    <h3>Add New Item</h3>
                    <p>Click to add a new registry item with dual photos and store links</p>
                `;
                addItemCard.addEventListener('click', () => this.showAddItemModal());

                grid.innerHTML = '';
                grid.appendChild(addItemCard);

                // Add existing items
                this.items.forEach(item => {
                    const itemElement = this.createRegistryItemElement(item);
                    grid.appendChild(itemElement);
                });
            }

            createRegistryItemElement(item) {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'registry-item-card';
                itemDiv.dataset.itemId = item.id;
                
                const progressPercentage = item.hasTarget ? Math.min((item.currentAmount / item.targetAmount) * 100, 100) : 0;
                const isCompleted = item.hasTarget && item.currentAmount >= item.targetAmount;
                
                // Handle both single and dual images
                let imagesHtml = '';
                if (item.imageUrl && item.imageUrl2) {
                    // Two images side by side
                    imagesHtml = `
                        <img src="${this.escapeHtml(item.imageUrl)}" alt="${this.escapeHtml(item.name)}" class="item-image-preview" onclick="adminApp.showImageUploadModal('${this.escapeHtml(item.id)}', 1)">
                        <img src="${this.escapeHtml(item.imageUrl2)}" alt="${this.escapeHtml(item.name)}" class="item-image-preview" onclick="adminApp.showImageUploadModal('${this.escapeHtml(item.id)}', 2)">
                    `;
                } else if (item.imageUrl) {
                    // One image with placeholder
                    imagesHtml = `
                        <img src="${this.escapeHtml(item.imageUrl)}" alt="${this.escapeHtml(item.name)}" class="item-image-preview" onclick="adminApp.showImageUploadModal('${this.escapeHtml(item.id)}', 1)">
                        <div class="image-placeholder" onclick="adminApp.showImageUploadModal('${this.escapeHtml(item.id)}', 2)">
                            <i class="fas fa-plus"></i>
                        </div>
                    `;
                } else {
                    // Two placeholders
                    imagesHtml = `
                        <div class="image-placeholder" onclick="adminApp.showImageUploadModal('${this.escapeHtml(item.id)}', 1)">
                            <i class="fas fa-camera"></i>
                        </div>
                        <div class="image-placeholder" onclick="adminApp.showImageUploadModal('${this.escapeHtml(item.id)}', 2)">
                            <i class="fas fa-plus"></i>
                        </div>
                    `;
                }

                // Generate store link display
                let storeLinkHtml = '';
                if (item.storeLink && item.storeLink.trim()) {
                    try {
                        const url = new URL(item.storeLink);
                        const hostname = url.hostname.replace('www.', '');
                        storeLinkHtml = `
                            <a href="${item.storeLink}" target="_blank" rel="noopener noreferrer" class="store-link-display">
                                <i class="fas fa-external-link-alt"></i>
                                ${hostname}
                            </a>
                        `;
                    } catch (e) {
                        storeLinkHtml = `
                            <a href="${item.storeLink}" target="_blank" rel="noopener noreferrer" class="store-link-display">
                                <i class="fas fa-external-link-alt"></i>
                                Store Link
                            </a>
                        `;
                    }
                }
                
                itemDiv.innerHTML = `
                    ${this.unsavedItems.has(item.id) ? '<div class="unsaved-indicator"></div>' : ''}
                    
                    <div class="item-images-container">
                        ${imagesHtml}
                    </div>
                    
                    <div class="item-content">
                        <div class="item-header">
                            <input type="text" class="item-title-editable" value="${this.escapeHtml(item.name)}"
                                   onchange="adminApp.updateItemField('${this.escapeHtml(item.id)}', 'name', this.value)"
                                   placeholder="Item name...">
                            <div class="item-actions">
                                <button class="action-btn drag-handle" title="Drag to reorder">
                                    <i class="fas fa-grip-vertical"></i>
                                </button>
                                <button class="action-btn save-btn" onclick="adminApp.saveItemChanges('${this.escapeHtml(item.id)}')" title="Save changes">
                                    <i class="fas fa-save"></i>
                                </button>
                                <button class="action-btn delete-btn" onclick="adminApp.deleteItem('${this.escapeHtml(item.id)}')" title="Delete item">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>

                        <textarea class="item-description-editable"
                                  onchange="adminApp.updateItemField('${this.escapeHtml(item.id)}', 'description', this.value)"
                                  placeholder="Item description...">${this.escapeHtml(item.description || '')}</textarea>

                        <input type="url" class="item-store-link-editable"
                               onchange="adminApp.updateItemField('${this.escapeHtml(item.id)}', 'storeLink', this.value)"
                               placeholder="https://store.com/product-link (optional)"
                               value="${this.escapeHtml(item.storeLink || '')}">
                        
                        ${storeLinkHtml}
                        
                        <div class="item-meta">
                            <div class="meta-field">
                                <label>Category</label>
                                <select onchange="adminApp.updateItemField('${item.id}', 'category', this.value)">
                                    <option value="kitchen" ${item.category === 'kitchen' ? 'selected' : ''}>Kitchen</option>
                                    <option value="home" ${item.category === 'home' ? 'selected' : ''}>Home</option>
                                    <option value="experiences" ${item.category === 'experiences' ? 'selected' : ''}>Experiences</option>
                                    <option value="other" ${item.category === 'other' ? 'selected' : ''}>Other</option>
                                </select>
                            </div>
                            <div class="meta-field">
                                <label>Target Amount ($)</label>
                                <input type="number" min="0" step="0.01" value="${item.targetAmount || 0}"
                                       onchange="adminApp.updateItemField('${item.id}', 'targetAmount', parseFloat(this.value) || 0)">
                            </div>
                            <div class="meta-field">
                                <label>Priority</label>
                                <select onchange="adminApp.updateItemField('${item.id}', 'priority', this.value)">
                                    <option value="low" ${item.priority === 'low' ? 'selected' : ''}>Low</option>
                                    <option value="medium" ${item.priority === 'medium' ? 'selected' : ''}>Medium</option>
                                    <option value="high" ${item.priority === 'high' ? 'selected' : ''}>High</option>
                                </select>
                            </div>
                            <div class="meta-field">
                                <label>Has Target</label>
                                <select onchange="adminApp.updateItemField('${item.id}', 'hasTarget', this.value === 'true')">
                                    <option value="true" ${item.hasTarget ? 'selected' : ''}>Yes</option>
                                    <option value="false" ${!item.hasTarget ? 'selected' : ''}>No</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="progress-info">
                            <div class="progress-bar-mini">
                                <div class="progress-fill-mini" style="width: ${progressPercentage}%"></div>
                            </div>
                            <div class="progress-text-mini">
                                <span>$${(item.currentAmount || 0).toFixed(2)} raised</span>
                                <span>${item.hasTarget ? `$${(item.targetAmount || 0).toFixed(2)} goal` : 'No target'}</span>
                            </div>
                            <div class="progress-text-mini">
                                <span>${(item.contributions && item.contributions.length) || 0} contributions</span>
                                <span style="color: ${isCompleted ? 'var(--success)' : 'var(--navy)'}">
                                    ${isCompleted ? 'Complete!' : `${progressPercentage.toFixed(1)}%`}
                                </span>
                            </div>
                        </div>
                    </div>
                `;
                
                return itemDiv;
            }

            setupSortable() {
                const grid = document.getElementById('registryItemsGrid');
                if (this.sortable) {
                    this.sortable.destroy();
                }
                
                this.sortable = new Sortable(grid, {
                    handle: '.drag-handle',
                    filter: '.add-item-card',
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    dragClass: 'sortable-drag',
                    onEnd: () => {
                        this.showToast('Order changed - click "Save Order" to save', 'warning');
                    }
                });
            }

            updateItemField(itemId, field, value) {
                const item = this.items.find(i => i.id == itemId);
                if (item) {
                    item[field] = value;
                    
                    // Update hasTarget based on targetAmount
                    if (field === 'targetAmount') {
                        item.hasTarget = value > 0;
                    }
                    
                    this.unsavedItems.add(itemId);
                    this.updateUnsavedIndicator(itemId);
                    this.debounceSave(itemId);

                    // Update store link display if it's a store link change
                    if (field === 'storeLink') {
                        this.refreshStoreLinkDisplay(itemId);
                    }
                }
            }

            refreshStoreLinkDisplay(itemId) {
                // Re-render just this item to update the store link display
                const itemElement = document.querySelector(`[data-item-id="${itemId}"]`);
                if (itemElement) {
                    const item = this.items.find(i => i.id == itemId);
                    if (item) {
                        // Find existing store link display and update it
                        const existingLink = itemElement.querySelector('.store-link-display');
                        if (existingLink) {
                            existingLink.remove();
                        }

                        // Add new store link display if there's a link
                        if (item.storeLink && item.storeLink.trim()) {
                            let storeLinkHtml = '';
                            try {
                                const url = new URL(item.storeLink);
                                const hostname = url.hostname.replace('www.', '');
                                storeLinkHtml = `
                                    <a href="${item.storeLink}" target="_blank" rel="noopener noreferrer" class="store-link-display">
                                        <i class="fas fa-external-link-alt"></i>
                                        ${hostname}
                                    </a>
                                `;
                            } catch (e) {
                                storeLinkHtml = `
                                    <a href="${item.storeLink}" target="_blank" rel="noopener noreferrer" class="store-link-display">
                                        <i class="fas fa-external-link-alt"></i>
                                        Store Link
                                    </a>
                                `;
                            }
                            
                            const storeLinkInput = itemElement.querySelector('.item-store-link-editable');
                            if (storeLinkInput && storeLinkHtml) {
                                storeLinkInput.insertAdjacentHTML('afterend', storeLinkHtml);
                            }
                        }
                    }
                }
            }

            updateUnsavedIndicator(itemId) {
                const itemElement = document.querySelector(`[data-item-id="${itemId}"]`);
                if (itemElement) {
                    if (this.unsavedItems.has(itemId)) {
                        if (!itemElement.querySelector('.unsaved-indicator')) {
                            const indicator = document.createElement('div');
                            indicator.className = 'unsaved-indicator';
                            itemElement.appendChild(indicator);
                        }
                    } else {
                        const indicator = itemElement.querySelector('.unsaved-indicator');
                        if (indicator) {
                            indicator.remove();
                        }
                    }
                }
            }

            debounceSave(itemId) {
                if (this.saveTimeout) {
                    clearTimeout(this.saveTimeout);
                }
                
                this.saveTimeout = setTimeout(() => {
                    this.saveItemChanges(itemId);
                }, 2000); // Auto-save after 2 seconds of inactivity
            }

            async saveItemChanges(itemId) {
                const item = this.items.find(i => i.id == itemId);
                if (!item) return;

                try {
                    this.showSaveIndicator('saving', 'Saving...');
                    
                    const response = await fetch(`/api/items/${itemId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.adminToken}`
                        },
                        body: JSON.stringify({
                            name: item.name,
                            description: item.description,
                            imageUrl: item.imageUrl,
                            imageUrl2: item.imageUrl2,
                            targetAmount: item.targetAmount,
                            hasTarget: item.hasTarget,
                            category: item.category,
                            priority: item.priority,
                            storeLink: item.storeLink
                        })
                    });

                    if (response.ok) {
                        this.unsavedItems.delete(itemId);
                        this.updateUnsavedIndicator(itemId);
                        this.showSaveIndicator('success', 'Changes saved!');
                    } else {
                        const errorText = await response.text();
                        console.error('Server error:', errorText);
                        throw new Error('Failed to save changes - server error');
                    }
                } catch (error) {
                    console.error('Error saving item:', error);
                    this.showSaveIndicator('error', 'Save failed!');
                    this.showToast(`Failed to save changes: ${error.message}`, 'error');
                }
            }

            async saveItemOrder() {
                try {
                    const grid = document.getElementById('registryItemsGrid');
                    const itemElements = Array.from(grid.querySelectorAll('.registry-item-card'));
                    
                    // Update the items array order
                    const newOrder = [];
                    itemElements.forEach(element => {
                        const itemId = element.dataset.itemId;
                        if (itemId) {
                            const item = this.items.find(i => i.id == itemId);
                            if (item) {
                                newOrder.push(item);
                            }
                        }
                    });
                    
                    this.items = newOrder;
                    this.showToast('Item order saved!', 'success');
                    
                } catch (error) {
                    console.error('Error saving item order:', error);
                    this.showToast('Failed to save item order', 'error');
                }
            }

            showAddItemModal() {
                this.editingItemId = null;
                document.getElementById('itemModalTitle').textContent = 'Add New Registry Item';
                document.getElementById('itemForm').reset();
                
                // Reset image previews
                document.getElementById('uploadPreview1').style.display = 'none';
                document.getElementById('uploadPreview2').style.display = 'none';
                document.getElementById('uploadContent1').style.display = 'block';
                document.getElementById('uploadContent2').style.display = 'block';
                
                document.getElementById('itemModal').style.display = 'block';
            }

            showEditItemModal(item) {
                this.editingItemId = item.id;
                document.getElementById('itemModalTitle').textContent = 'Edit Registry Item';
                
                // Populate form
                document.getElementById('itemName').value = item.name || '';
                document.getElementById('itemCategory').value = item.category || 'kitchen';
                document.getElementById('itemTargetAmount').value = item.targetAmount || '';
                document.getElementById('itemPriority').value = item.priority || 'medium';
                document.getElementById('itemDescription').value = item.description || '';
                document.getElementById('itemStoreLink').value = item.storeLink || '';
                
                // Show current images if exist
                if (item.imageUrl) {
                    document.getElementById('uploadPreview1').src = item.imageUrl;
                    document.getElementById('uploadPreview1').style.display = 'block';
                    document.getElementById('uploadContent1').style.display = 'none';
                    document.getElementById('clearImage1').style.display = 'flex';
                } else {
                    document.getElementById('uploadPreview1').style.display = 'none';
                    document.getElementById('uploadContent1').style.display = 'block';
                    document.getElementById('clearImage1').style.display = 'none';
                }

                if (item.imageUrl2) {
                    document.getElementById('uploadPreview2').src = item.imageUrl2;
                    document.getElementById('uploadPreview2').style.display = 'block';
                    document.getElementById('uploadContent2').style.display = 'none';
                    document.getElementById('clearImage2').style.display = 'flex';
                } else {
                    document.getElementById('uploadPreview2').style.display = 'none';
                    document.getElementById('uploadContent2').style.display = 'block';
                    document.getElementById('clearImage2').style.display = 'none';
                }
                
                document.getElementById('itemModal').style.display = 'block';
            }

            showImageUploadModal(itemId, slot) {
                this.currentImageSlot = { itemId, slot };
                const item = this.items.find(i => i.id == itemId);
                if (item) {
                    this.showEditItemModal(item);
                }
            }

            closeItemModal() {
                document.getElementById('itemModal').style.display = 'none';
                this.editingItemId = null;
                this.currentImageSlot = null;
            }

            async saveItem() {
                try {
                    // Get Storage URLs from data attributes (or fallback to src for legacy base64)
                    const preview1 = document.getElementById('uploadPreview1');
                    const preview2 = document.getElementById('uploadPreview2');

                    const formData = {
                        name: document.getElementById('itemName').value,
                        description: document.getElementById('itemDescription').value,
                        category: document.getElementById('itemCategory').value,
                        priority: document.getElementById('itemPriority').value,
                        targetAmount: parseFloat(document.getElementById('itemTargetAmount').value) || 0,
                        hasTarget: parseFloat(document.getElementById('itemTargetAmount').value) > 0,
                        storeLink: document.getElementById('itemStoreLink').value || '',
                        imageUrl: preview1?.dataset?.storageUrl || preview1?.src || '',
                        imageUrl2: preview2?.dataset?.storageUrl || preview2?.src || '',
                        imageUrlFaded: preview2?.dataset?.storageUrl || preview2?.src || '' // Support both field names
                    };

                    const saveBtn = document.getElementById('saveItemBtn');
                    saveBtn.innerHTML = '<i class="loading"></i> Saving...';
                    saveBtn.disabled = true;

                    let response;
                    if (this.editingItemId) {
                        // Edit existing item
                        response = await fetch(`/api/items/${this.editingItemId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.adminToken}`
                            },
                            body: JSON.stringify(formData)
                        });
                    } else {
                        // Add new item
                        response = await fetch('/api/items', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.adminToken}`
                            },
                            body: JSON.stringify(formData)
                        });
                    }

                    if (response.ok) {
                        this.showToast(this.editingItemId ? 'Item updated successfully!' : 'Item added successfully!', 'success');
                        this.closeItemModal();
                        await this.loadRegistryItems();
                    } else {
                        const errorText = await response.text();
                        console.error('Server error:', errorText);
                        throw new Error('Failed to save item - server error');
                    }
                } catch (error) {
                    console.error('Error saving item:', error);
                    this.showToast(`Failed to save item: ${error.message}`, 'error');
                } finally {
                    const saveBtn = document.getElementById('saveItemBtn');
                    saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Item';
                    saveBtn.disabled = false;
                }
            }

            async deleteItem(itemId) {
                const item = this.items.find(i => i.id == itemId);
                if (!item) return;

                if (confirm(`Are you sure you want to delete "${item.name}"? This action cannot be undone.`)) {
                    try {
                        const response = await fetch(`/api/items/${itemId}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${this.adminToken}`
                            }
                        });

                        if (response.ok) {
                            this.showToast('Item deleted successfully', 'success');
                            await this.loadRegistryItems();
                        } else {
                            throw new Error('Failed to delete item');
                        }
                    } catch (error) {
                        console.error('Error deleting item:', error);
                        this.showToast('Failed to delete item', 'error');
                    }
                }
            }

            async handleImageUpload(file, slot) {
                if (!file || !file.type.startsWith('image/')) {
                    this.showToast('Please select a valid image file', 'error');
                    return;
                }

                if (file.size > 10 * 1024 * 1024) { // 10MB limit
                    this.showToast('Image must be smaller than 10MB', 'error');
                    return;
                }

                const reader = new FileReader();
                reader.onload = async (e) => {
                    const preview = document.getElementById(`uploadPreview${slot}`);
                    const content = document.getElementById(`uploadContent${slot}`);
                    const clearBtn = document.getElementById(`clearImage${slot}`);

                    try {
                        // Show loading state
                        if (content) {
                            content.innerHTML = '<i class="loading"></i> Uploading...';
                        }

                        // Upload to Supabase Storage
                        const response = await fetch('/api/upload-image', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                image: e.target.result,
                                filename: file.name
                            })
                        });

                        if (!response.ok) {
                            throw new Error('Upload failed');
                        }

                        const data = await response.json();

                        // Store the Storage URL instead of base64
                        if (preview && content) {
                            preview.src = data.url;  // Use Storage URL
                            preview.dataset.storageUrl = data.url;  // Store for saveItem
                            preview.style.display = 'block';
                            content.innerHTML = '<i class="fas fa-cloud-upload-alt"></i><p>Drop image here or click to browse</p>';
                            content.style.display = 'none';
                            if (clearBtn) clearBtn.style.display = 'flex';

                            this.showToast(`Image ${slot} uploaded to Storage!`, 'success');
                        }
                    } catch (error) {
                        console.error('Upload error:', error);
                        this.showToast(`Failed to upload image ${slot}`, 'error');
                        if (content) {
                            content.innerHTML = '<i class="fas fa-cloud-upload-alt"></i><p>Drop image here or click to browse</p>';
                        }
                    }
                };
                reader.readAsDataURL(file);
            }

            clearImage(slot) {
                const preview = document.getElementById(`uploadPreview${slot}`);
                const content = document.getElementById(`uploadContent${slot}`);
                const clearBtn = document.getElementById(`clearImage${slot}`);
                const fileInput = document.getElementById(`imageUpload${slot}`);

                if (preview) {
                    preview.src = '';
                    preview.style.display = 'none';
                }
                if (content) {
                    content.style.display = 'block';
                }
                if (clearBtn) {
                    clearBtn.style.display = 'none';
                }
                if (fileInput) {
                    fileInput.value = '';
                }

                this.showToast(`Image ${slot} removed`, 'success');
            }

            showSaveIndicator(type, message) {
                const indicator = document.getElementById('saveIndicator');
                const text = document.getElementById('saveIndicatorText');
                
                indicator.className = `save-indicator ${type}`;
                text.textContent = message;
                indicator.classList.add('show');
                
                if (type === 'success' || type === 'error') {
                    setTimeout(() => {
                        indicator.classList.remove('show');
                    }, 3000);
                }
            }

            // Keep existing guest management methods
            async loadGuests() {
                try {
                    const response = await fetch('/api/admin/guests', {
                        headers: {
                            'Authorization': `Bearer ${this.adminToken}`
                        }
                    });

                    if (response.ok) {
                        this.guests = await response.json();
                        this.renderGuestsTable();
                    } else {
                        throw new Error('Failed to load guests');
                    }
                } catch (error) {
                    console.error('Error loading guests:', error);
                    this.showToast('Error loading guests', 'error');
                }
            }

            async loadStats() {
                try {
                    const response = await fetch('/api/statistics');
                    if (response.ok) {
                        const stats = await response.json();
                        this.renderStats(stats);
                    }
                } catch (error) {
                    console.error('Error loading stats:', error);
                }
            }

            renderStats(stats) {
                const statsGrid = document.getElementById('statsGrid');
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${this.guests.length}</div>
                        <div class="stat-label">Total Guests</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${this.guests.filter(g => g.hasAccessed).length}</div>
                        <div class="stat-label">Accessed Registry</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">$${stats.totalRaised.toFixed(0)}</div>
                        <div class="stat-label">Total Raised</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.totalContributions}</div>
                        <div class="stat-label">Total Contributions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${this.guests.filter(g => (g.totalContributed || 0) > 0).length}</div>
                        <div class="stat-label">Contributing Guests</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">$${stats.averageContribution.toFixed(0)}</div>
                        <div class="stat-label">Average Contribution</div>
                    </div>
                `;
            }

            renderGuestsTable() {
                const tbody = document.getElementById('guestsTableBody');
                tbody.innerHTML = this.guests.map(guest => `
                    <tr>
                        <td><strong>${this.escapeHtml(guest.name)}</strong></td>
                        <td>${this.escapeHtml(guest.email)}</td>
                        <td>
                            <code style="background: var(--beige); padding: 0.2rem 0.5rem; border-radius: 3px;">${this.escapeHtml(guest.guestCode)}</code>
                            <button onclick="navigator.clipboard.writeText('${this.escapeHtml(guest.guestCode)}')" style="background: var(--navy); color: white; border: none; padding: 0.2rem 0.5rem; border-radius: 3px; margin-left: 0.5rem; cursor: pointer;">
                                <i class="fas fa-copy"></i>
                            </button>
                        </td>
                        <td>
                            <span class="status-badge status-${this.escapeHtml(guest.rsvpStatus)}">
                                ${this.escapeHtml(guest.rsvpStatus)}
                            </span>
                        </td>
                        <td>
                            <span class="status-badge status-${guest.hasAccessed ? 'accessed' : 'not-accessed'}">
                                ${guest.hasAccessed ? 'Accessed' : 'Not Accessed'}
                            </span>
                        </td>
                        <td><strong>$${(guest.totalContributed || 0).toFixed(2)}</strong></td>
                        <td>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="action-btn" onclick="adminApp.editGuest(${guest.id})" style="background: var(--warning); color: white;">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn" onclick="adminApp.deleteGuest(${guest.id})" style="background: var(--error); color: white;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }

            filterGuests() {
                const search = document.getElementById('guestSearch').value.toLowerCase();
                const rsvpFilter = document.getElementById('rsvpFilter').value;
                const accessFilter = document.getElementById('accessFilter').value;

                const filteredGuests = this.guests.filter(guest => {
                    const matchesSearch = !search || 
                        guest.name.toLowerCase().includes(search) ||
                        guest.email.toLowerCase().includes(search) ||
                        guest.guestCode.toLowerCase().includes(search);
                    
                    const matchesRSVP = !rsvpFilter || guest.rsvpStatus === rsvpFilter;
                    
                    const matchesAccess = !accessFilter || 
                        (accessFilter === 'accessed' && guest.hasAccessed) ||
                        (accessFilter === 'not-accessed' && !guest.hasAccessed);
                    
                    return matchesSearch && matchesRSVP && matchesAccess;
                });

                const tbody = document.getElementById('guestsTableBody');
                tbody.innerHTML = filteredGuests.map(guest => `
                    <tr>
                        <td><strong>${this.escapeHtml(guest.name)}</strong></td>
                        <td>${this.escapeHtml(guest.email)}</td>
                        <td>
                            <code style="background: var(--beige); padding: 0.2rem 0.5rem; border-radius: 3px;">${this.escapeHtml(guest.guestCode)}</code>
                            <button onclick="navigator.clipboard.writeText('${this.escapeHtml(guest.guestCode)}')" style="background: var(--navy); color: white; border: none; padding: 0.2rem 0.5rem; border-radius: 3px; margin-left: 0.5rem; cursor: pointer;">
                                <i class="fas fa-copy"></i>
                            </button>
                        </td>
                        <td>
                            <span class="status-badge status-${this.escapeHtml(guest.rsvpStatus)}">
                                ${this.escapeHtml(guest.rsvpStatus)}
                            </span>
                        </td>
                        <td>
                            <span class="status-badge status-${guest.hasAccessed ? 'accessed' : 'not-accessed'}">
                                ${guest.hasAccessed ? 'Accessed' : 'Not Accessed'}
                            </span>
                        </td>
                        <td><strong>$${(guest.totalContributed || 0).toFixed(2)}</strong></td>
                        <td>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="action-btn" onclick="adminApp.editGuest(${guest.id})" style="background: var(--warning); color: white;">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn" onclick="adminApp.deleteGuest(${guest.id})" style="background: var(--error); color: white;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }

            async addGuest() {
                try {
                    const formData = {
                        name: document.getElementById('guestName').value,
                        email: document.getElementById('guestEmail').value,
                        phone: document.getElementById('guestPhone').value,
                        invitationType: document.getElementById('invitationType').value,
                        guestCount: parseInt(document.getElementById('guestCount').value),
                        dietaryRestrictions: document.getElementById('dietaryRestrictions').value,
                        notes: document.getElementById('guestNotes').value
                    };

                    const response = await fetch('/api/admin/guests', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.adminToken}`
                        },
                        body: JSON.stringify(formData)
                    });

                    if (response.ok) {
                        const newGuest = await response.json();
                        this.guests.push(newGuest);
                        this.renderGuestsTable();
                        
                        document.getElementById('addGuestForm').reset();
                        document.getElementById('guestCount').value = '1';
                        
                        this.showToast('Guest added successfully!', 'success');
                    } else {
                        const error = await response.json();
                        throw new Error(error.error || 'Failed to add guest');
                    }
                } catch (error) {
                    console.error('Error adding guest:', error);
                    this.showToast(error.message || 'Failed to add guest', 'error');
                }
            }

            async loadContributionReport() {
                try {
                    const response = await fetch('/api/admin/contributions-report', {
                        headers: {
                            'Authorization': `Bearer ${this.adminToken}`
                        }
                    });

                    if (response.ok) {
                        this.contributionReport = await response.json();
                        this.renderContributionReport();
                    } else {
                        throw new Error('Failed to load contribution report');
                    }
                } catch (error) {
                    console.error('Error loading contribution report:', error);
                    this.showToast('Error loading contribution report', 'error');
                }
            }

            renderContributionReport() {
                if (!this.contributionReport) return;

                const overview = document.getElementById('contributionOverview');
                overview.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number">${this.contributionReport.summary.guestsWhoContributed}</div>
                            <div class="stat-label">Contributing Guests</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">$${this.contributionReport.summary.totalRaised.toFixed(0)}</div>
                            <div class="stat-label">Total Raised</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">$${this.contributionReport.summary.averageContributionPerGuest.toFixed(0)}</div>
                            <div class="stat-label">Average Per Guest</div>
                        </div>
                    </div>
                `;

                const tbody = document.getElementById('contributionsTableBody');
                tbody.innerHTML = this.contributionReport.guestContributions.map(guest => `
                    <tr>
                        <td><strong>${guest.name}</strong></td>
                        <td>${guest.email}</td>
                        <td><strong>$${guest.totalContributed.toFixed(2)}</strong></td>
                        <td>
                            ${guest.contributions.map(c => `
                                <div style="font-size: 0.9rem; margin-bottom: 0.3rem;">
                                    ${c.itemName}: $${c.amount.toFixed(2)}
                                </div>
                            `).join('')}
                        </td>
                        <td>
                            ${guest.contributions.length > 0 ? 
                                new Date(guest.contributions[guest.contributions.length - 1].date).toLocaleDateString()
                                : 'No contributions'
                            }
                        </td>
                        <td>
                            <span class="status-badge ${guest.hasAccessed ? 'status-accessed' : 'status-not-accessed'}">
                                ${guest.hasAccessed ? 'Accessed' : 'Not Accessed'}
                            </span>
                        </td>
                    </tr>
                `).join('');
            }

            async loadRSVPs() {
                try {
                    const [rsvpsResponse, statsResponse] = await Promise.all([
                        fetch('/api/rsvps'),
                        fetch('/api/rsvp/stats')
                    ]);

                    if (rsvpsResponse.ok && statsResponse.ok) {
                        const rsvps = await rsvpsResponse.json();
                        const stats = await statsResponse.json();
                        this.renderRSVPs(rsvps, stats);
                    } else {
                        throw new Error('Failed to load RSVPs');
                    }
                } catch (error) {
                    console.error('Error loading RSVPs:', error);
                    this.showToast('Error loading RSVPs', 'error');
                }
            }

            renderRSVPs(rsvps, stats) {
                // Update statistics
                document.getElementById('attendingCount').textContent = stats.attending || 0;
                document.getElementById('notAttendingCount').textContent = stats.notAttending || 0;
                document.getElementById('maybeCount').textContent = stats.maybe || 0;
                document.getElementById('totalGuestsCount').textContent = stats.totalGuests || 0;

                // Render RSVPs table
                const tbody = document.getElementById('rsvpsTableBody');
                if (rsvps.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 3rem; color: var(--light-navy);">
                                <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                                <p>No RSVPs yet. Guests can RSVP via the main website.</p>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = rsvps.map(rsvp => {
                    const attendingBadge = rsvp.attending === 'yes'
                        ? '<span class="status-badge status-confirmed">‚úì Attending</span>'
                        : rsvp.attending === 'no'
                        ? '<span class="status-badge status-declined">‚úó Not Attending</span>'
                        : '<span class="status-badge status-pending">? Maybe</span>';

                    const date = new Date(rsvp.created_at).toLocaleDateString('en-NZ', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });

                    return `
                        <tr>
                            <td><strong>${this.escapeHtml(rsvp.name)}</strong></td>
                            <td>${rsvp.email ? this.escapeHtml(rsvp.email) : '<em>Not provided</em>'}</td>
                            <td>${rsvp.phone ? this.escapeHtml(rsvp.phone) : '<em>Not provided</em>'}</td>
                            <td>${attendingBadge}</td>
                            <td><strong>${rsvp.guest_count || 1}</strong></td>
                            <td>${rsvp.dietary_restrictions ? this.escapeHtml(rsvp.dietary_restrictions) : '<em>None</em>'}</td>
                            <td>${rsvp.message ? this.escapeHtml(rsvp.message) : '<em>No message</em>'}</td>
                            <td>${date}</td>
                            <td>
                                <button class="btn btn-danger" onclick="adminDashboard.deleteRSVP(${rsvp.id})" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            async deleteRSVP(rsvpId) {
                if (confirm('Are you sure you want to delete this RSVP?')) {
                    try {
                        const response = await fetch(`/api/rsvp/${rsvpId}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${this.adminToken}`
                            }
                        });

                        if (response.ok) {
                            this.showToast('RSVP deleted successfully', 'success');
                            await this.loadRSVPs();
                        } else {
                            throw new Error('Failed to delete RSVP');
                        }
                    } catch (error) {
                        console.error('Error deleting RSVP:', error);
                        this.showToast('Error deleting RSVP', 'error');
                    }
                }
            }

            exportGuestList() {
                this.exportToCSV(this.guests, 'wedding-guest-list.csv');
            }

            exportToCSV(data, filename) {
                const csvContent = this.convertToCSV(data);
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            convertToCSV(data) {
                if (!data.length) return '';
                
                const headers = Object.keys(data[0]);
                const csvRows = [headers.join(',')];
                
                data.forEach(row => {
                    const values = headers.map(header => {
                        const value = row[header];
                        return typeof value === 'string' && value.includes(',') ? `"${value}"` : value;
                    });
                    csvRows.push(values.join(','));
                });
                
                return csvRows.join('\n');
            }

            async editGuest(guestId) {
                const guest = this.guests.find(g => g.id == guestId);
                if (!guest) return;

                // Populate the modal fields
                document.getElementById('editGuestId').value = guest.id;
                document.getElementById('editGuestName').value = guest.name || '';
                document.getElementById('editGuestEmail').value = guest.email || '';
                document.getElementById('editGuestPhone').value = guest.phone || '';
                document.getElementById('editGuestCode').value = guest.guestCode || '';
                document.getElementById('editInvitationType').value = guest.invitationType || 'individual';
                document.getElementById('editGuestCount').value = guest.guestCount || 1;
                document.getElementById('editRsvpStatus').value = guest.rsvpStatus || 'pending';
                document.getElementById('editDietaryRestrictions').value = guest.dietaryRestrictions || '';
                document.getElementById('editGuestNotes').value = guest.notes || '';

                // Show the modal
                document.getElementById('guestModal').style.display = 'block';
            }

            closeGuestModal() {
                document.getElementById('guestModal').style.display = 'none';
                document.getElementById('guestEditForm').reset();
            }

            async saveGuestChanges() {
                try {
                    const guestId = document.getElementById('editGuestId').value;
                    const formData = {
                        name: document.getElementById('editGuestName').value,
                        email: document.getElementById('editGuestEmail').value,
                        phone: document.getElementById('editGuestPhone').value,
                        invitationType: document.getElementById('editInvitationType').value,
                        guestCount: parseInt(document.getElementById('editGuestCount').value) || 1,
                        rsvpStatus: document.getElementById('editRsvpStatus').value,
                        dietaryRestrictions: document.getElementById('editDietaryRestrictions').value,
                        notes: document.getElementById('editGuestNotes').value
                    };

                    const saveBtn = document.getElementById('saveGuestBtn');
                    saveBtn.innerHTML = '<i class="loading"></i> Saving...';
                    saveBtn.disabled = true;

                    const response = await fetch(`/api/admin/guests/${guestId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.adminToken}`
                        },
                        body: JSON.stringify(formData)
                    });

                    if (response.ok) {
                        this.showToast('Guest updated successfully!', 'success');
                        this.closeGuestModal();
                        await this.loadGuests();
                    } else {
                        const errorText = await response.text();
                        console.error('Server error:', errorText);
                        throw new Error('Failed to update guest');
                    }
                } catch (error) {
                    console.error('Error updating guest:', error);
                    this.showToast(`Failed to update guest: ${error.message}`, 'error');
                } finally {
                    const saveBtn = document.getElementById('saveGuestBtn');
                    saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
                    saveBtn.disabled = false;
                }
            }

            async deleteGuest(guestId) {
                const guest = this.guests.find(g => g.id == guestId);
                if (!guest) return;

                if (confirm(`Are you sure you want to delete ${guest.name}? This action cannot be undone.`)) {
                    try {
                        const response = await fetch(`/api/admin/guests/${guestId}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${this.adminToken}`
                            }
                        });

                        if (response.ok) {
                            this.guests = this.guests.filter(g => g.id !== guestId);
                            this.renderGuestsTable();
                            this.showToast('Guest deleted successfully', 'success');
                        } else {
                            throw new Error('Failed to delete guest');
                        }
                    } catch (error) {
                        console.error('Error deleting guest:', error);
                        this.showToast('Failed to delete guest', 'error');
                    }
                }
            }

            // Site Content Editor Methods
            async loadSiteContent() {
                try {
                    const response = await fetch('/api/content');
                    if (!response.ok) throw new Error('Failed to load content');

                    const content = await response.json();
                    this.renderContentEditor(content);
                } catch (error) {
                    console.error('Error loading site content:', error);
                    document.getElementById('contentEditorContainer').innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--error);">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>Failed to load content. Please make sure you've created the site_content table in Supabase.</p>
                            <p style="font-size: 0.9rem; margin-top: 1rem;">Run CREATE_SITE_CONTENT_TABLE.sql in your Supabase SQL editor.</p>
                        </div>
                    `;
                }
            }

            renderContentEditor(content) {
                const sections = {
                    hero: [],
                    about: [],
                    schedule: [],
                    accommodation: [],
                    faq: [],
                    registry: [],
                    gallery: []
                };

                // Organize content by section
                Object.keys(content).forEach(key => {
                    const item = content[key];
                    if (item.section && sections[item.section]) {
                        sections[item.section].push({ key, ...item });
                    }
                });

                const sectionTitles = {
                    hero: 'üéä Hero Section',
                    about: 'üíï About Section',
                    schedule: 'üìÖ Schedule Section',
                    accommodation: 'üè® Accommodation & Travel',
                    faq: '‚ùì FAQ Section',
                    registry: 'üéÅ Registry Section',
                    gallery: 'üì∑ Gallery Section'
                };

                let html = '';
                Object.keys(sections).forEach(sectionKey => {
                    const items = sections[sectionKey];
                    if (items.length === 0) return;

                    html += `
                        <div class="content-section-group" style="margin-bottom: 2rem;">
                            <h3 style="color: var(--navy); margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--beige);">
                                ${sectionTitles[sectionKey]}
                            </h3>
                            <div class="content-fields">
                    `;

                    items.forEach(item => {
                        const inputId = `content_${item.key}`;
                        const isTextarea = item.type === 'textarea';

                        html += `
                            <div class="form-field" style="margin-bottom: 1.5rem;">
                                <label for="${inputId}" style="font-weight: 600; color: var(--light-navy); display: block; margin-bottom: 0.5rem;">
                                    ${item.description || item.key}
                                </label>
                                ${isTextarea ?
                                    `<textarea id="${inputId}" data-key="${item.key}" rows="3" style="width: 100%; padding: 0.75rem; border: 2px solid var(--beige); border-radius: 8px; font-family: inherit; font-size: 1rem;">${this.escapeHtml(item.value)}</textarea>` :
                                    `<input type="text" id="${inputId}" data-key="${item.key}" value="${this.escapeHtml(item.value)}" style="width: 100%; padding: 0.75rem; border: 2px solid var(--beige); border-radius: 8px; font-size: 1rem;">`
                                }
                                <button onclick="dashboard.saveContent('${item.key}')" class="btn btn-primary" style="margin-top: 0.5rem;">
                                    <i class="fas fa-save"></i> Save
                                </button>
                            </div>
                        `;
                    });

                    html += `
                            </div>
                        </div>
                    `;
                });

                document.getElementById('contentEditorContainer').innerHTML = html;
            }

            async saveContent(key) {
                try {
                    const inputEl = document.getElementById(`content_${key}`);
                    const value = inputEl.value;

                    const response = await fetch(`/api/content/${key}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.adminToken}`
                        },
                        body: JSON.stringify({ value })
                    });

                    if (!response.ok) throw new Error('Failed to save content');

                    this.showToast('Content updated successfully!', 'success');

                    // Highlight the field briefly
                    inputEl.style.borderColor = 'var(--success)';
                    inputEl.style.backgroundColor = '#f0fff4';
                    setTimeout(() => {
                        inputEl.style.borderColor = '';
                        inputEl.style.backgroundColor = '';
                    }, 1000);

                } catch (error) {
                    console.error('Error saving content:', error);
                    this.showToast('Failed to save content', 'error');
                }
            }

            showToast(message, type = 'success') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                    ${message}
                `;
                
                document.body.appendChild(toast);
                
                setTimeout(() => toast.classList.add('show'), 100);
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => document.body.removeChild(toast), 300);
                }, 4000);
            }
        }

        // Global functions for onclick events
        function closeItemModal() {
            if (adminApp) adminApp.closeItemModal();
        }

        function closeGuestModal() {
            if (adminApp) adminApp.closeGuestModal();
        }

        // Initialize admin dashboard
        let adminApp;
        document.addEventListener('DOMContentLoaded', () => {
            adminApp = new AdminDashboard();
        });
    </script>
</body>
</html>